<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>G40 Attendance System </title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; padding: 20px; max-width: 1000px; margin: auto; background-color: #f0f2f5; color: #333; }
        h1 { text-align: center; color: #1a73e8; }
        
        .container { display: flex; gap: 20px; flex-wrap: wrap; }
        .card { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); flex: 1; min-width: 300px; }
        
        input, select { width: 100%; padding: 10px; margin: 5px 0; border: 1px solid #ccc; border-radius: 6px; }
        button { background-color: #1a73e8; color: white; border: none; padding: 10px; cursor: pointer; width: 100%; border-radius: 6px; font-weight: bold; margin-top: 5px; }
        button:hover { background-color: #1557b0; }
        
        #logoutBtn { background-color: #dc3545; width: auto; float: right; }
        #addClassBtn { background-color: #6610f2; } 
        #exportBtn { background-color: #28a745; }
        
        .schedule-item { 
            background: #f8f9fa; 
            border-left: 4px solid #6610f2; 
            padding: 12px; 
            margin-bottom: 8px; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            border-radius: 4px;
        }
        .delete-btn { background: #dc3545; color: white; border: none; padding: 4px 10px; font-size: 0.8em; width: auto; margin: 0; border-radius: 4px;}

        #loginScreen { max-width: 400px; margin: 100px auto; text-align: center; background: white; padding: 40px; border-radius: 12px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
        #dashboardScreen { display: none; }
        
        ul { list-style: none; padding: 0; }
        li { background: #f8f9fa; border-bottom: 1px solid #eee; padding: 10px; display: flex; justify-content: space-between; }
        
        /* New Style for Date Picker Area */
        .date-control {
            background-color: #e8f0fe;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            border: 1px solid #d2e3fc;
        }
    </style>
</head>
<body>

    <div id="loginScreen">
        <h2>üîí Staff Login</h2>
        <input type="email" id="emailInput" placeholder="Lecturer Email" />
        <input type="password" id="passwordInput" placeholder="Password" />
        <button id="loginBtn">Log In</button>
        <p id="loginError" style="color:red; display:none;"></p>
    </div>

    <div id="dashboardScreen">
        <h1>üè´ Lecture Hall Management</h1>
        <button id="logoutBtn">Log Out</button>
        <div style="clear:both; margin-bottom: 20px;"></div>

        <div class="container">
            
            <div class="card">
                <h2>üìÖ Admin: Booking Panel</h2>
                <p><i>Taken time slots are automatically removed.</i></p>
                
                <label>Select Day</label>
                <select id="bookDay">
                    <option value="1">Monday</option>
                    <option value="2">Tuesday</option>
                    <option value="3">Wednesday</option>
                    <option value="4">Thursday</option>
                    <option value="5">Friday</option>
                    <option value="6">Saturday</option>
                    <option value="0">Sunday</option>
                </select>

                <div style="display:flex; gap:10px;">
                    <div style="flex:1">
                        <label>Start Time</label>
                        <select id="bookTime"></select>
                    </div>
                    <div style="flex:1">
                        <label>Duration (Hrs)</label>
                        <input type="number" id="bookDuration" value="2" min="1" max="4">
                    </div>
                </div>

                <label>Subject Name</label>
                <input type="text" id="bookName" placeholder="e.g. Circuit Design">
                <button id="addClassBtn">‚ûï Book Slot</button>
                <hr>
                <div id="bookingList">Loading...</div>
            </div>

            <div class="card">
                <h2>üìä Attendance Monitor</h2>
                
                <div class="date-control">
                    <label style="font-weight:bold; color:#1a73e8;">Select Date to View:</label>
                    <input type="date" id="historyDate">
                    <small id="dayLabel" style="display:block; margin-top:5px; color:#555;">Detected Day: ...</small>
                </div>

                <label>Classes for Selected Date:</label>
                <select id="classSelector">
                    <option value="">-- No classes found --</option>
                </select>

                <h3 id="activeClassTitle" style="color: #1a73e8; border-bottom: 2px solid #ddd; padding-bottom: 5px;">Waiting...</h3>
                <button id="exportBtn">üì• Download CSV</button>
                
                <h4>Present: <span id="count" style="color: #1a73e8;">0</span></h4>
                <ul id="attendanceList"></ul>
            </div>
            
            <div class="card">
                <h3>üì° Simulator</h3>
                <input type="text" id="simName" placeholder="Name">
                <input type="text" id="simID" placeholder="ID">
                <button id="simBtn">Simulate Scan</button>
                <p id="simStatus" style="color:green"></p>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, push, set, remove, query, orderByChild, startAt, onValue, get } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
        import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        // üî¥ PASTE YOUR CONFIG HERE
        const firebaseConfig = {
            apiKey: "AIzaSyC9CqjVBCcmjeYAZdX3grW213s2jyMHpAw",
            authDomain: "g40attendance.firebaseapp.com",
            databaseURL: "https://g40attendance-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "g40attendance",
            storageBucket: "g40attendance.firebasestorage.app",
            messagingSenderId: "487009872314",
            appId: "1:487009872314:web:9842ea3115be17e5505583"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const auth = getAuth(app);

        let currentClassData = [];
        let currentClassName = "";

        // AUTH
        document.getElementById('loginBtn').addEventListener('click', () => {
            signInWithEmailAndPassword(auth, document.getElementById('emailInput').value, document.getElementById('passwordInput').value)
                .catch(e => { document.getElementById('loginError').innerText = e.message; document.getElementById('loginError').style.display = 'block'; });
        });
        document.getElementById('logoutBtn').addEventListener('click', () => signOut(auth));

        onAuthStateChanged(auth, (user) => {
            if (user) {
                document.getElementById('loginScreen').style.display = 'none';
                document.getElementById('dashboardScreen').style.display = 'block';
                
                // Set Date Picker to Today by default
                document.getElementById('historyDate').valueAsDate = new Date();
                
                loadAdminPanel();
                loadScheduleForSelectedDate(); // Load today's list initially
            } else {
                document.getElementById('loginScreen').style.display = 'block';
                document.getElementById('dashboardScreen').style.display = 'none';
            }
        });

        // ============================
        // 1. ADMIN PANEL LOGIC
        // ============================
        function loadAdminPanel() {
            updateAvailableTimeSlots(); 
            loadScheduleList();
        }

        document.getElementById('bookDay').addEventListener('change', () => {
            updateAvailableTimeSlots();
            loadScheduleList();
        });

        function updateAvailableTimeSlots() {
            const day = document.getElementById('bookDay').value;
            const timeSelect = document.getElementById('bookTime');
            
            get(ref(db, `class_schedule/${day}`)).then((snapshot) => {
                const blockedHours = []; 
                if (snapshot.exists()) {
                    snapshot.forEach(child => {
                        const cls = child.val();
                        const startHour = parseInt(cls.start_time.split(":")[0]);
                        for(let i=0; i < cls.duration; i++) {
                            const h = startHour + i;
                            blockedHours.push((h<10?"0":"")+h+"00");
                        }
                    });
                }
                timeSelect.innerHTML = "";
                for(let i=0; i<24; i++) {
                    const hStr = (i<10?"0":"")+i+":00";
                    const idStr = (i<10?"0":"")+i+"00";
                    if (!blockedHours.includes(idStr)) {
                        const op = document.createElement('option');
                        op.value = hStr; op.innerText = hStr;
                        timeSelect.appendChild(op);
                    }
                }
                if(timeSelect.options.length===0) timeSelect.innerHTML="<option>Full</option>";
            });
        }

        document.getElementById('addClassBtn').addEventListener('click', () => {
            const day = document.getElementById('bookDay').value;
            const time = document.getElementById('bookTime').value; 
            const name = document.getElementById('bookName').value;
            const dur = document.getElementById('bookDuration').value;

            if(!name || time === "Full") { alert("Check details"); return; }
            const timeID = time.replace(":", ""); 
            
            set(ref(db, `class_schedule/${day}/${timeID}`), {
                name: name, start_time: time, duration: parseInt(dur)
            }).then(() => {
                alert("Class Booked!");
                updateAvailableTimeSlots();
            });
        });

        function loadScheduleList() {
            const day = document.getElementById('bookDay').value;
            const list = document.getElementById('bookingList');
            
            onValue(ref(db, `class_schedule/${day}`), (snapshot) => {
                list.innerHTML = "";
                if(!snapshot.exists()) { list.innerHTML = "<small>No classes booked.</small>"; return; }
                
                snapshot.forEach(child => {
                    const cls = child.val();
                    const startHour = parseInt(cls.start_time.split(":")[0]);
                    const endHour = startHour + cls.duration;
                    const endString = (endHour < 10 ? "0" : "") + endHour + ":00";
                    
                    const div = document.createElement('div');
                    div.className = "schedule-item";
                    div.innerHTML = `<div><span style="font-size:1.1em; font-weight:bold; color:#6610f2;">${cls.start_time} - ${endString}</span><br><span>${cls.name}</span></div><button class="delete-btn">Delete</button>`;
                    div.querySelector('button').addEventListener('click', () => {
                        if(confirm("Delete?")) remove(ref(db, `class_schedule/${day}/${child.key}`)).then(()=>updateAvailableTimeSlots());
                    });
                    list.appendChild(div);
                });
            });
        }

        // ============================
        // 2. LIVE & HISTORY MONITOR (NEW LOGIC)
        // ============================
        
        // Listen for Date Picker Changes
        document.getElementById('historyDate').addEventListener('change', loadScheduleForSelectedDate);

        function loadScheduleForSelectedDate() {
            const dateInput = document.getElementById('historyDate').value; // YYYY-MM-DD
            if(!dateInput) return;

            const dateObj = new Date(dateInput);
            const dayIndex = dateObj.getDay(); // Get Day of Week (0-6) for that date
            const days = ["Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"];
            
            document.getElementById('dayLabel').innerText = "Detected Day: " + days[dayIndex];

            // Fetch Schedule for that Day of Week
            const selector = document.getElementById('classSelector');
            onValue(ref(db, `class_schedule/${dayIndex}`), (snapshot) => {
                selector.innerHTML = "";
                if(!snapshot.exists()) { selector.innerHTML = `<option value="">No classes found for ${days[dayIndex]}</option>`; return; }
                
                snapshot.forEach(child => {
                    const cls = child.val();
                    const option = document.createElement('option');
                    option.value = `${cls.start_time},${cls.duration},${cls.name}`;
                    option.innerText = `${cls.start_time} - ${cls.name}`;
                    selector.appendChild(option);
                });
                selector.dispatchEvent(new Event('change'));
            });
        }

        document.getElementById('classSelector').addEventListener('change', (e) => {
            const val = e.target.value;
            if(!val) return;
            const [startStr, durStr, name] = val.split(","); 
            const startHour = parseInt(startStr.split(":")[0]);
            loadAttendance(startHour, name, parseInt(durStr));
        });

        // ============================
        // 3. ATTENDANCE QUERY (UPDATED FOR DATE PICKER)
        // ============================
        function getTimestampForSelectedDate(hour) {
            const dateVal = document.getElementById('historyDate').value;
            const t = new Date(dateVal); // Create date object from picker
            t.setHours(hour, 0, 0, 0); // Set time
            return t.getTime();
        }

        function loadAttendance(startHour, className, duration) {
            document.getElementById('activeClassTitle').innerText = `üìÇ ${className}`;
            currentClassName = className;
            
            // USE NEW FUNCTION TO GET DATE FROM PICKER
            const start = getTimestampForSelectedDate(startHour);
            const end = start + (duration * 3600000);

            onValue(query(ref(db, 'attendance_logs'), orderByChild('timestamp'), startAt(start)), (snap) => {
                const list = document.getElementById('attendanceList');
                list.innerHTML = "";
                let count = 0;
                currentClassData = [];
                
                snap.forEach(c => {
                    const d = c.val();
                    // Double check time range
                    if(d.timestamp < end) {
                        // Format time based on log timestamp
                        const time = new Date(d.timestamp).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'});
                        list.innerHTML += `<li><b>${d.name}</b> <span>${time}</span></li>`;
                        currentClassData.push({Name:d.name, ID:d.student_id, Time:time});
                        count++;
                    }
                });
                document.getElementById('count').innerText = count;
            });
        }

        document.getElementById('exportBtn').addEventListener('click', () => {
            if(!currentClassData.length) return alert("No data");
            
            // Add Date to filename for clarity
            const dateStr = document.getElementById('historyDate').value;
            
            let csv = "data:text/csv;charset=utf-8,Name,ID,Time\n" + currentClassData.map(r=>`${r.Name},${r.ID},${r.Time}`).join("\n");
            const a = document.createElement("a"); a.href = encodeURI(csv); 
            a.download=`Attendance_${currentClassName}_${dateStr}.csv`; 
            a.click();
        });
        
        document.getElementById('simBtn').addEventListener('click', () => {
            const n = document.getElementById('simName').value;
            const i = document.getElementById('simID').value;
            if(n) push(ref(db, 'attendance_logs'), { name: n, student_id: i, timestamp: Date.now() });
        });

    </script>
</body>
</html>